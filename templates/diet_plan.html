{% extends 'base.html'%} {% block uber_content %}

<div class="main_container px-lg-0 text-center pt-4">
    <!----------------------Buttons generate diet plan and shopping list------------------>

    <div class="row d-flex justify-content-center pt-3">
        <div class="col-4">
            <!------------ Button trigger modal Generate diet plan------------- -->
            <button id="generate_diet_plan" type="button" class="btn btn-warning mb-1" data-toggle="modal"
                data-target="#dietPlanModalCenter"><i class="fa fa-calendar-check h6"></i>
                <span class="h6">Generate diet plan</span>
            </button>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="dietPlanModalCenter" tabindex="-1" role="dialog"
            aria-labelledby="dietPlanModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-success" id="dietPlanModalCenterTitle">Diet plan</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="print" class="border pr-3 pl-3 ">

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <!------------------ Button trigger modal  Generate shopping list-------------------->
            <button type="button" class="btn btn-warning" id="generate_shopping_list" data-toggle="modal"
                data-target="#shopingListModalScrollable">
               
                    <i class="fas fa-list h6"></i>
                    <span class="h6">Generate shopping list</span>
              
            </button>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="shopingListModalScrollable" tabindex="-1" role="dialog"
            aria-labelledby="shopingListModalScrollableTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-success text-center" id="shopingListModalScrollableTitle">
                            Shoping
                            List
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <ul class="list-group list-group-flush shopping_list">
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row main_content justify-content-center">
        <!-----------------------------Carousel diet plan-------------------------->
        <div class="p-0">
            <div id="Indicators" class="carousel row row_carousel slide mt-4" data-ride="carousel"
                data-interval=false>
                <ol class="carousel-indicators">
                    <li data-target="#Indicators" data-slide-to="0" class="active"></li>
                    <li data-target="#Indicators" data-slide-to="1"></li>
                    <li data-target="#Indicators" data-slide-to="2"></li>
                    <li data-target="#Indicators" data-slide-to="3"></li>
                    <li data-target="#Indicators" data-slide-to="4"></li>
                    <li data-target="#Indicators" data-slide-to="5"></li>
                    <li data-target="#Indicators" data-slide-to="6"></li>
                </ol>
                <!--------------------------------Modal Meals List------------------->

                <div id="modal_meals_list" class="modal fade meal_list_modal show" tabindex="-1" role="dialog"
                    aria-labelledby="myLargeModalLabel" style="display: none; padding-right: 17px;">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title text-success" id="myLargeModalLabel">Select meal from list</h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">Ã—</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <!-------Search input------->
                                    <div class="col-5 p-0 pt-2">
                                        <form class="row form-inline md-form form-sm ml-2 mb-3">
                                            <i class="fas fa-search" aria-hidden="true"></i>
                                            <input id="myInput" class="form-control form-control-sm ml-3 w-75"
                                                type="text" placeholder="Search" aria-label="Search">
                                        </form>
                                    </div>
                                    <!----------------all tags----------->
                                    <div class="col-6 text-center pt-0">
                                        <div class="font-weight-bold">Click tag to refine search:</div>
                                        <div id="all_tags" class="col-12 text-justify py-2 px-0"></div>
                                    </div>
                                </div>
                                <hr>
                                <!-------------------------Recipes list---------------------------------------->
                                <div id="recipes-list" class="mt-3">
                                    <div class="container-fluid">
                                        <div class="row justify-content-center">

                                        </div>

                                    </div>
                                </div>
                                <!----------Feedback for user that search returned no results-------------->
                                <div class="nothingFound_diet" style="display:none">
                                    <p><span>Whoops!</span> </br>Sorry, but nothing matched your search. Please try some
                                        different
                                        keywords.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="carousel-inner mb-5">
                    {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <div class="carousel-item {% if loop.first %} active {% endif %}">
                        <!-------------------------------------day of the week Monday------------>
                        <div class="justify-content-center days-of-the-week row  p-3 mb-4 font-weight-bold">
                            <span class="day-of-the-week">{{day}}</span>
                        </div>
                        <div class="container-flex meals-carousel mb-4">
                            <div class="row d-flex justify-content-center mb-4">
                                <div class="meal col-5 mr-4">
                                    <div class="row">
                                        <div class="category_name h4 text-center col-12 py-3 rounded-top">Breakfast</div>
                                    </div>
                                    <div class="row">
                                        <div class="container meal_carousel p-0 m-0"> 
                                            <div
                                                class="slideShowRecipeTitle row justify-content-center font-weight-bold text-info h5 py-3">&nbsp;
                                            </div>
                                            <img src="{{url_for('static', filename='images/foodPlaceholder.png')}}"
                                                class="slideShowRecipeImage img-thumbnail rounded img-fluid max-width: 100% sidebar-image"
                                                data-toggle="modal" data-target=".meal_list_modal">
                                        </div>
                                    </div>
                                </div>
                                <div class="meal col-5">
                                    <div class="row">
                                        <div class="category_name h4 text-center col-12 py-3 rounded-top">Lunch</div>
                                    </div>
                                    <div class="row">
                                        <div class="container meal_carousel p-0 m-0">
                                            <div
                                                class="slideShowRecipeTitle row justify-content-center font-weight-bold text-info h5 py-3">&nbsp;
                                            </div>
                                            <img src="{{url_for('static', filename='images/foodPlaceholder.png')}}"
                                                class="slideShowRecipeImage img-thumbnail rounded img-fluid max-width: 100% sidebar-image"
                                                data-toggle="modal" data-target=".meal_list_modal">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row d-flex justify-content-center">
                                <div class="meal col-5 mr-4">
                                    <div class="row">
                                        <div class="category_name h4 text-center col-12 py-3 rounded-top">Tea</div>
                                    </div>
                                    <div class="row">
                                        <div class="container meal_carousel p-0 m-0">
                                            <div
                                                class="slideShowRecipeTitle row justify-content-center font-weight-bold text-info h5 py-3">&nbsp;
                                            </div>
                                            <img src="{{url_for('static', filename='images/foodPlaceholder.png')}}"
                                                class="slideShowRecipeImage img-thumbnail rounded img-fluid max-width: 100% sidebar-image"
                                                data-toggle="modal" data-target=".meal_list_modal">
                                        </div>
                                    </div>
                                </div>
                                <div class="meal col-5">
                                    <div class="row">
                                        <div class="category_name h4 text-center col-12 py-3 rounded-top">Dinner</div>
                                    </div>
                                    <div class="row">
                                        <div class="container meal_carousel p-0 m-0">
                                            <div
                                                class="slideShowRecipeTitle row justify-content-center font-weight-bold text-info h5 py-3">&nbsp;
                                            </div>
                                            <img src="{{url_for('static', filename='images/foodPlaceholder.png')}}"
                                                class="slideShowRecipeImage img-thumbnail rounded img-fluid max-width: 100% sidebar-image"
                                                data-toggle="modal" data-target=".meal_list_modal">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <a class="carousel-control-prev" href="#Indicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#Indicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>

            </div>

        </div>
    </div>

    {% endblock %}

    {% block scripts %}

    <script type="text/javascript">
        $(document).ready(function () {

            const recipes = {{ recipes | tojson
        }};
        const recipesMap = new Map(recipes.map(r => [r.title, r]));

        $("table i").click(function () {
            $(this).parents("tr").remove()
        })


        // Fill in list with all recipes

        // 1. Find with jquery element to put recipes to 
        const $recipesList = $("#recipes-list .row");

        // 2. For each in recipes add new html object (create with jQuery) to recipes list

        recipes.forEach(function (recipe) {
            $newElem = $(`<div class="recipe-sidebar card inline-block col-4 p-0 mb-1" data-tags="${recipe.tags}">
                             <div class="card-body">
                                     <h5 class="card-title rec-title text-center text-info">${recipe.title}</h5>
                             </div>
                                 <img src="${recipe.image}" class="rec-image card-img-top rounded-bottom img-fluid max-width: 100%">
                                 
                        </div>`)

            $newElem.click(function () {
                $slideShowRecipe = $(".meal_carousel.chosen_meal")
                $slideShowRecipe.find(".slideShowRecipeTitle").text($(this).find(".rec-title").text())
                $slideShowRecipe.find(".slideShowRecipeImage").attr("src", $(this).find(".rec-image").attr("src"))
                $("#modal_meals_list").modal('hide')
                $slideShowRecipe.removeClass("chosen_meal")
            });

            $recipesList.append($newElem)
        })

        // add selected recipe to carusel 

        $(".slideShowRecipeImage").click(function () {
            $(this).parents(".meal_carousel").addClass("chosen_meal")
        })

        // load all tags from all recipes
        let distinctTags = new Set()
        recipes.forEach(function (recipe) {
            if (recipe.tags) {
                recipe.tags.forEach(function (tag) {
                    distinctTags.add(tag)
                })
            }
        })

        Array.from(distinctTags).sort().forEach(function (tag) {
            $("#all_tags").append(`<h6 class="d-inline"><span class="tag badge badge-warning align-middle mr-1"><span class="tag_name">${tag}</span>
                        <button type="button" class="close_diet close pl-2" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </span>
                </h6>`)
        })

        $(document).on("click", "#all_tags > h6", function () {
            $(this).toggleClass("active")
            filterCards()
        })

        $(document).on("click", ".close_diet", function () {
            $(this).toggleClass("active")
            filterCards()
        })

        function filterCards() {
            var currentValue = $("#myInput").val().toLowerCase().trim();

            // Get all cards
            var allCards = $("#recipes-list").find(".recipe-sidebar");

            // Remove display none from all cards
            allCards.show();

            // filtering tags
            const filteringTags = $("#all_tags .active .tag_name").map(function () {
                return String($(this).text())
            }).toArray();

            // Filter cards that lowercase title don't contain search value
            var nonMatchingCards = allCards.filter(function () {
                const titleText = $(this).find(".rec-title ").text().toLowerCase().trim();
                const tags = Array.from($(this).data("tags").split(","));

                return titleText.indexOf(currentValue) === -1 || (filteringTags && filteringTags.some(function (filterTag) {
                    return !tags.some(tag => tag === filterTag)
                }));
            });


            // Set display none to all filtered cards
            nonMatchingCards.hide();

            // if there are no search results show info 
            if (nonMatchingCards.length === allCards.length) {
                $(".nothingFound_diet").show();

            } else {
                $(".nothingFound_diet").hide();

            }
        }

        $("#myInput").keyup(function () {
            filterCards()
        });

        /*---------------------------Generate diet plan button----------------------*/

        $("#generate_diet_plan").click(function () {
            $print = $("#print");
            $print.empty();

            $(".carousel-item").each(function (current_card) {
                $print.append(`<div class="row bg-warning p-3 border font-weight-bold">${$(this).find(".day-of-the-week").text()}</div>`)
                $print.append(`<div class="row p-2 border-top-0">
                        <div class="col-4 text-center p-1 font-weight-bold">Meal:</div>
                        <div class="col-4 text-center p-1 font-weight-bold">Ingredients List:</div>
                        <div class="col-4 text-center p-1 font-weight-bold">Steps:</div>
                </div>`)

                $(this).find(".category_name").each(function (category_index) {

                    const dish_name = $(this).parents(".meal").find(`.slideShowRecipeTitle`).text();
                    if (dish_name && dish_name.trim() !== "") {
                        const recipe = recipesMap.get(dish_name);

                        $row = $(`<div class="row"></div>`)
                        $col1 = $(`<div class="col-4 nopadding ">
                                    <div class="container">
                                        <div class="row  p-1 border-bottom border-top text-uppercase font-weight-bold">${$(this).text()}</div>
                                        <div class="row  p-1 font-italic">${dish_name}</div>
                                        </div>
                                </div>`)
                        $col2 = $(`<div class="col-4 border"></div>`)
                        $col3 = $(`<div class="col-4 border"></div>`)
                        $inglist = $(`<ul class="small"></ul>`)
                        recipe.ingredients.forEach(function (i) {
                            $inglist.append(`<li>${i.name}</li>`)
                        })

                        $steplist = $(`<ol class="small"></ol>`)
                        if (recipe.recipe && Array.isArray(recipe.recipe)) {
                            recipe.recipe.forEach(function (step) {
                                $steplist.append(`<li>${step}</li>`)
                            })
                        }
                        $col2.append($inglist)
                        $col3.append($steplist)
                        $row.append($col1)
                        $row.append($col2)
                        $row.append($col3)

                        $print.append($row)
                    }
                })

            })

        })


        /*--------------------------Generate shopping list button-------------------*/

        $("#generate_shopping_list").click(function () {

            $shopping_list = $(".shopping_list");
            $shopping_list.empty();

            let all_ingredients = new Map()

            $(".carousel-item").each(function (day_index) {
                $(this).find(".category_name").each(function (category_index) {

                    const dish_name = $(this).parents(".meal").find(`.slideShowRecipeTitle`).text();
                    if (dish_name && dish_name.trim() !== "") {
                        const recipe = recipesMap.get(dish_name);

                        recipe.ingredients.forEach(i => {
                            const floatAmount = parseFloat(i.amount);

                            if (all_ingredients.has(i.name)) {
                                if (all_ingredients.get(i.name).has(i.unit)) {
                                    const newValue = all_ingredients.get(i.name).get(i.unit) + floatAmount
                                    all_ingredients.get(i.name).set(i.unit, newValue);

                                } else {
                                    all_ingredients.get(i.name).set(i.unit, floatAmount)
                                }
                            } else {
                                all_ingredients.set(i.name, new Map())
                                all_ingredients.get(i.name).set(i.unit, floatAmount)
                            }
                        })

                    }
                })


            })

            for (const [name, unit_amount] of all_ingredients.entries()) {


                for (const [unit, amount] of unit_amount.entries()) {
                    $shopping_list.append(`<li class ="list-group-item">
                                             <div class="row">
                                                <div class="col-3">${name}</div>
                                                <div class="col-1">${amount}</div>
                                                <div class="col-1">${unit}</div>
                                                </div>
                                        </li>`)
                }
            }


        })
})

    </script>

    {% endblock %}

    {% block styles %}

    .main_container {
    margin: 0 2em;
    padding: 0;
    }

    .container.general {
    display: none;
    }

    {% endblock %}